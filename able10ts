#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TS_DIR="$SCRIPT_DIR/interpreter10"

resolve_path() {
  local candidate="$1"
  if [[ -f "$SCRIPT_DIR/$candidate" ]]; then
    realpath "$SCRIPT_DIR/$candidate"
    return 0
  fi
  if [[ -f "$candidate" ]]; then
    realpath "$candidate"
    return 0
  fi
  printf '%s\n' "$candidate"
  return 0
}

build_args() {
  local args=()
  if [[ $# -gt 0 ]]; then
    local first="$1"
    shift
    case "$first" in
      run|check)
        args+=("$first")
        if [[ $# -gt 0 ]]; then
          local candidate="$1"
          shift
          args+=("$(resolve_path "$candidate")")
        fi
        if [[ $# -gt 0 ]]; then
          args+=("$@")
        fi
        ;;
      test)
        args+=("$first")
        if [[ $# -gt 0 ]]; then
          args+=("$@")
        fi
        ;;
      *)
        args+=("run")
        args+=("$(resolve_path "$first")")
        if [[ $# -gt 0 ]]; then
          args+=("$@")
        fi
        ;;
    esac
  fi
  printf '%s\0' "${args[@]}"
}

mapfile -d '' ARGS < <(build_args "$@")

cd "$TS_DIR"
exec bun run scripts/run-module.ts "${ARGS[@]}"
