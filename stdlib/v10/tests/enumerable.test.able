package collections.specs

import able.testing.assertions.{AssertionError}
import able.testing.rspec.{describe, expect, eq, be_truthy, be_false}
import able.collections.array.{Array}

describe("Enumerable helpers") { suite =>
  suite.it("maps and filters arrays") { _ctx =>
    values: Array i32 := Array.new()
    values.push(1)
    values.push(2)
    values.push(3)

    doubled := values.map(fn(value: i32) -> i32 { value * 2 })
    sum := doubled.reduce(0, fn(acc: i32, value: i32) -> i32 { acc + value })
    expect(sum).to(eq(12))

    evens := values.filter(fn(value: i32) -> bool { value % 2 == 0 })
    expect(evens.count()).to(eq(1))
    match evens.first() {
      case nil => raise AssertionError { message: "expected even element", details: nil, location: nil },
      case value: i32 => expect(value).to(eq(2))
    }
  }

  suite.it("computes predicates") { _ctx =>
    values: Array string := Array.new()
    values.push("a")
    values.push("bb")
    values.push("ccc")

    expect(values.any(fn(value: string) -> bool { value.len() == 2 })).to(be_truthy())
    expect(values.all(fn(value: string) -> bool { value.len() >= 1 })).to(be_truthy())
    expect(values.none(fn(value: string) -> bool { value == "zzz" })).to(be_truthy())
  }

  suite.it("finds elements") { _ctx =>
    values: Array i32 := Array.new()
    values.push(1)
    values.push(3)
    values.push(5)
    values.push(8)
    found := values.find(fn(value: i32) -> bool { value % 2 == 0 })
    match found {
      case nil => raise AssertionError { message: "expected even value", details: nil, location: nil },
      case value: i32 => expect(value).to(eq(8))
    }
    expect(values.find(fn(value: i32) -> bool { value > 10 })).to(eq(nil))
  }

  suite.it("reduces values") { _ctx =>
    values: Array i32 := Array.new()
    values.push(1)
    values.push(2)
    values.push(3)
    values.push(4)
    sum := values.reduce(0, fn(acc: i32, value: i32) -> i32 { acc + value })
    expect(sum).to(eq(10))
  }

  suite.it("handles first/is_empty") { _ctx =>
    empty: Array i32 := Array.new()
    filled: Array i32 := Array.new()
    filled.push(42)

    expect(empty.first()).to(eq(nil))
    expect(empty.is_empty()).to(be_truthy())

    expect(filled.first()).to(eq(42))
    expect(filled.is_empty()).to(be_false())
  }
}
