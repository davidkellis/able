#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
GO_DIR="$SCRIPT_DIR/interpreter10-go"
CACHE_DIR="$GO_DIR/.gocache"

resolve_path() {
  local candidate="$1"
  if [[ -f "$SCRIPT_DIR/$candidate" ]]; then
    realpath "$SCRIPT_DIR/$candidate"
    return 0
  fi
  if [[ -f "$candidate" ]]; then
    realpath "$candidate"
    return 0
  fi
  printf '%s\n' "$candidate"
  return 0
}

build_args() {
  local args=()
  if [[ $# -gt 0 ]]; then
    local first="$1"
    shift
    if [[ "$first" == "run" ]]; then
      args+=("run")
      if [[ $# -gt 0 ]]; then
        local candidate="$1"
        shift
        args+=("$(resolve_path "$candidate")")
      fi
      if [[ $# -gt 0 ]]; then
        args+=("$@")
      fi
    else
      args+=("$(resolve_path "$first")")
      if [[ $# -gt 0 ]]; then
        args+=("$@")
      fi
    fi
  fi
  printf '%s\0' "${args[@]}"
}

mapfile -d '' ARGS < <(build_args "$@")

exec env GOCACHE="$CACHE_DIR" go run -C "$GO_DIR" ./cmd/able "${ARGS[@]}"
