package registry

import able.kernel.{Array}
import able.collections.array
import able.test.protocol.{Framework}

struct FrameworkEntry {
  id: String,
  framework: Framework
}

REGISTERED: Array FrameworkEntry := Array.new()

fn register_framework(framework: Framework) -> void {
  id := framework.id()
  idx := 0
  loop {
    if idx >= REGISTERED.len() { break }
    REGISTERED.get(idx) match {
      case nil => {},
      case entry: FrameworkEntry => {
        if entry.id == id {
          REGISTERED.set(idx, FrameworkEntry { id, framework })
          return
        }
      }
    }
    idx = idx + 1
  }
  REGISTERED.push(FrameworkEntry { id, framework })
}

fn each_framework(visit: Framework -> void) -> void {
  idx := 0
  loop {
    if idx >= REGISTERED.len() { break }
    REGISTERED.get(idx) match {
      case nil => {},
      case entry: FrameworkEntry => visit(entry.framework)
    }
    idx = idx + 1
  }
}

fn framework_by_id(id: String) -> ?Framework {
  idx := 0
  loop {
    if idx >= REGISTERED.len() { break }
    REGISTERED.get(idx) match {
      case nil => {},
      case entry: FrameworkEntry => {
        if entry.id == id { return entry.framework }
      }
    }
    idx = idx + 1
  }
  nil
}

## Intended for tests to reset registry state.
fn clear_registry() -> void {
  REGISTERED = Array.new()
}
