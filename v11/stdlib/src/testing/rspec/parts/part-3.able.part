fn push_suite(name: string) -> SuiteBuilder {
  let parent_index = SUITE_STACK.len() - 1
  let mut path: Array string = Array.new()
  let mut module_path = ""
  let mut tags: Array string = Array.new()
  let mut before_each: Array (ExampleContext -> void) = Array.new()
  let mut after_each: Array (ExampleContext -> void) = Array.new()
  let mut before_all: Array (ExampleContext -> void) = Array.new()
  let mut after_all: Array (ExampleContext -> void) = Array.new()
  let mut config = SuiteConfig { allow_parallel: false }

  if parent_index >= 0 {
    match SUITE_STACK.get(parent_index) {
      case nil => {},
      case parent: SuiteState => {
        path = clone_string_array(parent.path)
        module_path = parent.module_path
        tags = clone_string_array(parent.tags)
        before_each = clone_hook_array(parent.before_each)
        after_each = clone_hook_array(parent.after_each)
        config = parent.config
      }
    }
  }

  path.push(name)
  if module_path == "" {
    module_path = build_suite_key(path)
  }
  let state = SuiteState {
    key: build_suite_key(path),
    path,
    module_path,
    tags,
    before_each,
    after_each,
    before_all,
    after_all,
    config
  }

  SUITE_STACK.push(state)
  SuiteBuilder { state_index: (SUITE_STACK.len() - 1) as i32 }
}

fn pop_suite() -> void {
  match SUITE_STACK.pop() {
    case nil => {},
    case state: SuiteState => register_suite(state)
  }
}

fn register_suite(state: SuiteState) -> void {
  let definition = SuiteDefinition {
    key: state.key,
    path: clone_string_array(state.path),
    before_all: clone_hook_array(state.before_all),
    after_all: clone_hook_array(state.after_all)
  }

  let mut idx = 0
  loop {
    if idx >= SUITES.len() { break }
    match SUITES.get(idx) {
      case nil => {},
      case existing: SuiteDefinition => {
        if existing.key == state.key {
          SUITES.set(idx, definition)
          return
        }
      }
    }
    idx = idx + 1
  }

  SUITES.push(definition)
}

fn find_suite(key: string) -> ?SuiteDefinition {
  let mut idx = 0
  loop {
    if idx >= SUITES.len() { break }
    match SUITES.get(idx) {
      case nil => {},
      case suite: SuiteDefinition => {
        if suite.key == key { return suite }
      }
    }
    idx = idx + 1
  }
  nil
}

fn find_example(id: string) -> ?ExampleDefinition {
  let mut idx = 0
  loop {
    if idx >= EXAMPLES.len() { break }
    match EXAMPLES.get(idx) {
      case nil => {},
      case example: ExampleDefinition => {
        if example.id == id { return example }
      }
    }
    idx = idx + 1
  }
  nil
}

fn build_suite_key(path: Array string) -> string {
  join_segments(path, "::")
}

fn build_example_id(path: Array string, name: string) -> string {
  let mut segments = clone_string_array(path)
  segments.push(name)
  join_segments(segments, "::")
}

fn build_example_display(path: Array string, name: string) -> string {
  let mut segments = clone_string_array(path)
  segments.push(name)
  join_segments(segments, " ")
}

fn join_segments(segments: Array string, separator: string) -> string {
  let mut result = ""
  let mut idx = 0
  loop {
    if idx >= segments.len() { break }
    match segments.get(idx) {
      case nil => {},
      case segment: string => {
        if result == "" {
          result = segment
        } else {
          result = `${result}${separator}${segment}`
        }
      }
    }
    idx = idx + 1
  }
  result
}

