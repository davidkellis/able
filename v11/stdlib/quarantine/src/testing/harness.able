package testing

import able.collections.array.{Array}
import able.testing.protocol.{
  DiscoveryRequest,
  Failure,
  Framework,
  Reporter,
  RunOptions,
  TestDescriptor,
  TestPlan
}
import able.testing.registry.{each_framework}

fn discover_all(request: DiscoveryRequest) -> !(Array TestDescriptor) {
  let mut descriptors: Array TestDescriptor = Array.new()
  let mut failure: ?Failure = nil

  each_framework(fn(framework: Framework) {
    match failure {
      case nil => {},
      case _ => { return }
    }

    match framework.discover(request, fn(descriptor: TestDescriptor) -> void {
      descriptors.push(descriptor)
    }) {
      case nil => {},
      case err: Failure => { failure = err }
    }
  })

  match failure {
    case nil => descriptors,
    case err: Failure => err
  }
}

fn descriptors_for_framework(descriptors: Array TestDescriptor, id: string) -> Array TestDescriptor {
  let mut filtered: Array TestDescriptor = Array.new()
  let mut idx = 0
  loop {
    if idx >= descriptors.len() { break }
    match descriptors.get(idx) {
      case nil => {},
      case descriptor: TestDescriptor => {
        if descriptor.framework_id == id {
          filtered.push(descriptor)
        }
      }
    }
    idx = idx + 1
  }
  filtered
}

fn run_plan(plan: TestPlan, options: RunOptions, reporter: Reporter) -> ?Failure {
  let mut failure: ?Failure = nil
  let focus_filtered = filter_focus(plan.descriptors)

  each_framework(fn(framework: Framework) {
    match failure {
      case nil => {},
      case _ => { return }
    }

    let descriptors = descriptors_for_framework(focus_filtered, framework.id())
    if descriptors.len() == 0 { return }

    let sub_plan = TestPlan { descriptors }
    match framework.run(sub_plan, options, reporter) {
      case nil => {},
      case err: Failure => { failure = err }
    }
  })

  failure
}

fn filter_focus(descriptors: Array TestDescriptor) -> Array TestDescriptor {
  let mut has_focus = false
  let mut idx = 0
  loop {
    if idx >= descriptors.len() { break }
    match descriptors.get(idx) {
      case nil => {},
      case descriptor: TestDescriptor => {
        if tag_contains(descriptor.tags, "focus") {
          has_focus = true
          break
        }
      }
    }
    idx = idx + 1
  }

  if !has_focus { return descriptors }

  let mut filtered: Array TestDescriptor = Array.new()
  idx = 0
  loop {
    if idx >= descriptors.len() { break }
    match descriptors.get(idx) {
      case nil => {},
      case descriptor: TestDescriptor => {
        if tag_contains(descriptor.tags, "focus") {
          filtered.push(descriptor)
        }
      }
    }
    idx = idx + 1
  }
  filtered
}

fn tag_contains(tags: Array string, needle: string) -> bool {
  let mut idx = 0
  loop {
    if idx >= tags.len() { break }
    match tags.get(idx) {
      case nil => {},
      case value: string => {
        if value == needle { return true }
      }
    }
    idx = idx + 1
  }
  false
}

fn run_all(request: DiscoveryRequest, options: RunOptions, reporter: Reporter) -> ?Failure {
  match discover_all(request) {
    case failure: Failure => failure,
    case descriptors: Array TestDescriptor => {
      let plan = TestPlan { descriptors }
      run_plan(plan, options, reporter)
    }
  }
}
