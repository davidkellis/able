#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
GO_DIR="$SCRIPT_DIR/interpreters/go"
GO_CACHE="$GO_DIR/.gocache"

usage() {
  cat <<'EOF'
Usage: ablego [--] <command-or-entry> [args...]

Runs the Able v11 Go interpreter (cmd/able). Provide `run` or `check` to use
the CLI commands explicitly, or pass a source file path directly.

Examples:
  # Run a source file
  ./v11/ablego examples/hello_world.able

  # Check a manifest target
  ./v11/ablego check hello_world
EOF
}

resolve_path() {
  local candidate="$1"
  if [[ -z "$candidate" ]]; then
    printf '%s\n' "$candidate"
    return 0
  fi
  if [[ -f "$candidate" ]]; then
    realpath "$candidate"
    return 0
  fi
  if [[ -f "$SCRIPT_DIR/$candidate" ]]; then
    realpath "$SCRIPT_DIR/$candidate"
    return 0
  fi
  printf '%s\n' "$candidate"
}

build_go_args() {
  GO_ARGS=()
  if [[ $# -eq 0 ]]; then
    return
  fi

  local first="$1"
  shift || true
  case "$first" in
    run|check)
      GO_ARGS+=("$first")
      if [[ $# -gt 0 ]]; then
        local candidate="$1"
        shift || true
        GO_ARGS+=("$(resolve_path "$candidate")")
      fi
      if [[ $# -gt 0 ]]; then
        GO_ARGS+=("$@")
      fi
      ;;
    deps|--help|-h|--version|-V|version)
      GO_ARGS+=("$first")
      if [[ $# -gt 0 ]]; then
        GO_ARGS+=("$@")
      fi
      ;;
    *)
      GO_ARGS+=("$(resolve_path "$first")")
      if [[ $# -gt 0 ]]; then
        GO_ARGS+=("$@")
      fi
      ;;
  esac
}

ensure_go_dir() {
  if [[ ! -d "$GO_DIR" ]]; then
    echo "Able v11 Go interpreter directory not found at $GO_DIR" >&2
    exit 1
  fi
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      usage
      exit 0
      ;;
    --)
      shift
      break
      ;;
    *)
      break
      ;;
  esac
done

cmd_args=("$@")

if [[ ${#cmd_args[@]} -eq 0 ]]; then
  echo "Expected an entrypoint, manifest target, or interpreter command." >&2
  echo "Use --help to see usage examples." >&2
  exit 1
fi

ensure_go_dir
mkdir -p "$GO_CACHE"
build_go_args "${cmd_args[@]}"

echo "[Able v11 Go] go run ./cmd/able ${GO_ARGS[*]}"
if env GOCACHE="$GO_CACHE" go run -C "$GO_DIR" ./cmd/able "${GO_ARGS[@]}"; then
  exit 0
else
  code=$?
  echo "Able v11 Go interpreter exited with status $code" >&2
  exit "$code"
fi

